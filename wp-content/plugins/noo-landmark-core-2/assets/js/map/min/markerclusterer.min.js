function ClusterIcon(e,t){e.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView),this.cluster_=e,this.className_=e.getMarkerClusterer().getClusterClass(),this.styles_=t,this.center_=null,this.div_=null,this.sums_=null,this.visible_=!1,this.setMap(e.getMap())}function Cluster(e){this.markerClusterer_=e,this.map_=e.getMap(),this.gridSize_=e.getGridSize(),this.minClusterSize_=e.getMinimumClusterSize(),this.averageCenter_=e.getAverageCenter(),this.markers_=[],this.center_=null,this.bounds_=null,this.clusterIcon_=new ClusterIcon(this,e.getStyles())}function MarkerClusterer(e,t,o){this.extend(MarkerClusterer,google.maps.OverlayView),t=t||[],o=o||{},this.markers_=[],this.clusters_=[],this.listeners_=[],this.activeMap_=null,this.ready_=!1,this.gridSize_=o.gridSize||60,this.minClusterSize_=o.minimumClusterSize||2,this.maxZoom_=o.maxZoom||null,this.styles_=o.styles||[],this.title_=o.title||"",this.zoomOnClick_=!0,void 0!==o.zoomOnClick&&(this.zoomOnClick_=o.zoomOnClick),this.averageCenter_=!1,void 0!==o.averageCenter&&(this.averageCenter_=o.averageCenter),this.ignoreHidden_=!1,void 0!==o.ignoreHidden&&(this.ignoreHidden_=o.ignoreHidden),this.enableRetinaIcons_=!1,void 0!==o.enableRetinaIcons&&(this.enableRetinaIcons_=o.enableRetinaIcons),this.imagePath_=o.imagePath||MarkerClusterer.IMAGE_PATH,this.imageExtension_=o.imageExtension||MarkerClusterer.IMAGE_EXTENSION,this.imageSizes_=o.imageSizes||MarkerClusterer.IMAGE_SIZES,this.calculator_=o.calculator||MarkerClusterer.CALCULATOR,this.batchSize_=o.batchSize||MarkerClusterer.BATCH_SIZE,this.batchSizeIE_=o.batchSizeIE||MarkerClusterer.BATCH_SIZE_IE,this.clusterClass_=o.clusterClass||"cluster",-1!==navigator.userAgent.toLowerCase().indexOf("msie")&&(this.batchSize_=this.batchSizeIE_),this.setupStyles_(),this.addMarkers(t,!0),this.setMap(e)}ClusterIcon.prototype.onAdd=function(){var e,t,o=this;this.div_=document.createElement("div"),this.div_.className=this.className_,this.visible_&&this.show(),this.getPanes().overlayMouseTarget.appendChild(this.div_),this.boundsChangedListener_=google.maps.event.addListener(this.getMap(),"bounds_changed",function(){t=e}),google.maps.event.addDomListener(this.div_,"mousedown",function(){e=!0,t=!1}),google.maps.event.addDomListener(this.div_,"click",function(i){if(e=!1,!t){var s,n,a=o.cluster_.getMarkerClusterer();google.maps.event.trigger(a,"click",o.cluster_),google.maps.event.trigger(a,"clusterclick",o.cluster_),a.getZoomOnClick()&&(n=a.getMaxZoom(),s=o.cluster_.getBounds(),a.getMap().fitBounds(s),setTimeout(function(){a.getMap().fitBounds(s),null!==n&&a.getMap().getZoom()>n&&a.getMap().setZoom(n+1)},100)),i.cancelBubble=!0,i.stopPropagation&&i.stopPropagation()}}),google.maps.event.addDomListener(this.div_,"mouseover",function(){var e=o.cluster_.getMarkerClusterer();google.maps.event.trigger(e,"mouseover",o.cluster_)}),google.maps.event.addDomListener(this.div_,"mouseout",function(){var e=o.cluster_.getMarkerClusterer();google.maps.event.trigger(e,"mouseout",o.cluster_)})},ClusterIcon.prototype.onRemove=function(){this.div_&&this.div_.parentNode&&(this.hide(),google.maps.event.removeListener(this.boundsChangedListener_),google.maps.event.clearInstanceListeners(this.div_),this.div_.parentNode.removeChild(this.div_),this.div_=null)},ClusterIcon.prototype.draw=function(){if(this.visible_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.top=e.y+"px",this.div_.style.left=e.x+"px"}},ClusterIcon.prototype.hide=function(){this.div_&&(this.div_.style.display="none"),this.visible_=!1},ClusterIcon.prototype.show=function(){if(this.div_){var e="",t=this.backgroundPosition_.split(" "),o=parseInt(t[0].replace(/^\s+|\s+$/g,""),10),i=parseInt(t[1].replace(/^\s+|\s+$/g,""),10),s=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(s),e="<img src='"+this.url_+"' style='position: absolute; top: "+i+"px; left: "+o+"px; ",this.cluster_.getMarkerClusterer().enableRetinaIcons_||(e+="clip: rect("+-1*i+"px, "+(-1*o+this.width_)+"px, "+(-1*i+this.height_)+"px, "+-1*o+"px);"),e+="'>",this.div_.innerHTML=e+"<div style='position: absolute;top: "+this.anchorText_[0]+"px;left: "+this.anchorText_[1]+"px;color: "+this.textColor_+";font-size: "+this.textSize_+"px;font-family: "+this.fontFamily_+";font-weight: "+this.fontWeight_+";font-style: "+this.fontStyle_+";text-decoration: "+this.textDecoration_+";text-align: center;width: "+this.width_+"px;line-height:"+this.height_+"px;'>"+this.sums_.text+"</div>","undefined"==typeof this.sums_.title||""===this.sums_.title?this.div_.title=this.cluster_.getMarkerClusterer().getTitle():this.div_.title=this.sums_.title,this.div_.style.display=""}this.visible_=!0},ClusterIcon.prototype.useStyle=function(e){this.sums_=e;var t=Math.max(0,e.index-1);t=Math.min(this.styles_.length-1,t);var o=this.styles_[t];this.url_=o.url,this.height_=o.height,this.width_=o.width,this.anchorText_=o.anchorText||[0,0],this.anchorIcon_=o.anchorIcon||[parseInt(this.height_/2,10),parseInt(this.width_/2,10)],this.textColor_=o.textColor||"black",this.textSize_=o.textSize||11,this.textDecoration_=o.textDecoration||"none",this.fontWeight_=o.fontWeight||"bold",this.fontStyle_=o.fontStyle||"normal",this.fontFamily_=o.fontFamily||"Arial,sans-serif",this.backgroundPosition_=o.backgroundPosition||"0 0"},ClusterIcon.prototype.setCenter=function(e){this.center_=e},ClusterIcon.prototype.createCss=function(e){var t=[];return t.push("cursor: pointer;"),t.push("position: absolute; top: "+e.y+"px; left: "+e.x+"px;"),t.push("width: "+this.width_+"px; height: "+this.height_+"px;"),t.join("")},ClusterIcon.prototype.getPosFromLatLng_=function(e){var t=this.getProjection().fromLatLngToDivPixel(e);return t.x-=this.anchorIcon_[1],t.y-=this.anchorIcon_[0],t.x=parseInt(t.x,10),t.y=parseInt(t.y,10),t},Cluster.prototype.getSize=function(){return this.markers_.length},Cluster.prototype.getMarkers=function(){return this.markers_},Cluster.prototype.getCenter=function(){return this.center_},Cluster.prototype.getMap=function(){return this.map_},Cluster.prototype.getMarkerClusterer=function(){return this.markerClusterer_},Cluster.prototype.getBounds=function(){var e,t=new google.maps.LatLngBounds(this.center_,this.center_),o=this.getMarkers();for(e=0;e<o.length;e++)t.extend(o[e].getPosition());return t},Cluster.prototype.remove=function(){this.clusterIcon_.setMap(null),this.markers_=[],delete this.markers_},Cluster.prototype.addMarker=function(e){var t,o,i;if(this.isMarkerAlreadyAdded_(e))return!1;if(this.center_){if(this.averageCenter_){var s=this.markers_.length+1,n=(this.center_.lat()*(s-1)+e.getPosition().lat())/s,a=(this.center_.lng()*(s-1)+e.getPosition().lng())/s;this.center_=new google.maps.LatLng(n,a),this.calculateBounds_()}}else this.center_=e.getPosition(),this.calculateBounds_();if(e.isAdded=!0,this.markers_.push(e),o=this.markers_.length,i=this.markerClusterer_.getMaxZoom(),null!==i&&this.map_.getZoom()>i)e.getMap()!==this.map_&&e.setMap(this.map_);else if(o<this.minClusterSize_)e.getMap()!==this.map_&&e.setMap(this.map_);else if(o===this.minClusterSize_)for(t=0;o>t;t++)this.markers_[t].setMap(null);else e.setMap(null);return this.updateIcon_(),!0},Cluster.prototype.isMarkerInClusterBounds=function(e){return this.bounds_.contains(e.getPosition())},Cluster.prototype.calculateBounds_=function(){var e=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(e)},Cluster.prototype.updateIcon_=function(){var e=this.markers_.length,t=this.markerClusterer_.getMaxZoom();if(null!==t&&this.map_.getZoom()>t)return void this.clusterIcon_.hide();if(e<this.minClusterSize_)return void this.clusterIcon_.hide();var o=this.markerClusterer_.getStyles().length,i=this.markerClusterer_.getCalculator()(this.markers_,o);this.clusterIcon_.setCenter(this.center_),this.clusterIcon_.useStyle(i),this.clusterIcon_.show()},Cluster.prototype.isMarkerAlreadyAdded_=function(e){var t;if(this.markers_.indexOf)return-1!==this.markers_.indexOf(e);for(t=0;t<this.markers_.length;t++)if(e===this.markers_[t])return!0;return!1},MarkerClusterer.prototype.onAdd=function(){var e=this;this.activeMap_=this.getMap(),this.ready_=!0,this.repaint(),this.listeners_=[google.maps.event.addListener(this.getMap(),"zoom_changed",function(){e.resetViewport_(!1),(this.getZoom()===(this.get("minZoom")||0)||this.getZoom()===this.get("maxZoom"))&&google.maps.event.trigger(this,"idle")}),google.maps.event.addListener(this.getMap(),"idle",function(){e.redraw_()})]},MarkerClusterer.prototype.onRemove=function(){var e;for(e=0;e<this.markers_.length;e++)this.markers_[e].getMap()!==this.activeMap_&&this.markers_[e].setMap(this.activeMap_);for(e=0;e<this.clusters_.length;e++)this.clusters_[e].remove();for(this.clusters_=[],e=0;e<this.listeners_.length;e++)google.maps.event.removeListener(this.listeners_[e]);this.listeners_=[],this.activeMap_=null,this.ready_=!1},MarkerClusterer.prototype.draw=function(){},MarkerClusterer.prototype.setupStyles_=function(){var e,t;if(!(this.styles_.length>0))for(e=0;e<this.imageSizes_.length;e++)t=this.imageSizes_[e],this.styles_.push({url:this.imagePath_+(e+1)+"."+this.imageExtension_,height:t,width:t})},MarkerClusterer.prototype.fitMapToMarkers=function(){var e,t=this.getMarkers(),o=new google.maps.LatLngBounds;for(e=0;e<t.length;e++)o.extend(t[e].getPosition());this.getMap().fitBounds(o)},MarkerClusterer.prototype.getGridSize=function(){return this.gridSize_},MarkerClusterer.prototype.setGridSize=function(e){this.gridSize_=e},MarkerClusterer.prototype.getMinimumClusterSize=function(){return this.minClusterSize_},MarkerClusterer.prototype.setMinimumClusterSize=function(e){this.minClusterSize_=e},MarkerClusterer.prototype.getMaxZoom=function(){return this.maxZoom_},MarkerClusterer.prototype.setMaxZoom=function(e){this.maxZoom_=e},MarkerClusterer.prototype.getStyles=function(){return this.styles_},MarkerClusterer.prototype.setStyles=function(e){this.styles_=e},MarkerClusterer.prototype.getTitle=function(){return this.title_},MarkerClusterer.prototype.setTitle=function(e){this.title_=e},MarkerClusterer.prototype.getZoomOnClick=function(){return this.zoomOnClick_},MarkerClusterer.prototype.setZoomOnClick=function(e){this.zoomOnClick_=e},MarkerClusterer.prototype.getAverageCenter=function(){return this.averageCenter_},MarkerClusterer.prototype.setAverageCenter=function(e){this.averageCenter_=e},MarkerClusterer.prototype.getIgnoreHidden=function(){return this.ignoreHidden_},MarkerClusterer.prototype.setIgnoreHidden=function(e){this.ignoreHidden_=e},MarkerClusterer.prototype.getEnableRetinaIcons=function(){return this.enableRetinaIcons_},MarkerClusterer.prototype.setEnableRetinaIcons=function(e){this.enableRetinaIcons_=e},MarkerClusterer.prototype.getImageExtension=function(){return this.imageExtension_},MarkerClusterer.prototype.setImageExtension=function(e){this.imageExtension_=e},MarkerClusterer.prototype.getImagePath=function(){return this.imagePath_},MarkerClusterer.prototype.setImagePath=function(e){this.imagePath_=e},MarkerClusterer.prototype.getImageSizes=function(){return this.imageSizes_},MarkerClusterer.prototype.setImageSizes=function(e){this.imageSizes_=e},MarkerClusterer.prototype.getCalculator=function(){return this.calculator_},MarkerClusterer.prototype.setCalculator=function(e){this.calculator_=e},MarkerClusterer.prototype.getBatchSizeIE=function(){return this.batchSizeIE_},MarkerClusterer.prototype.setBatchSizeIE=function(e){this.batchSizeIE_=e},MarkerClusterer.prototype.getClusterClass=function(){return this.clusterClass_},MarkerClusterer.prototype.setClusterClass=function(e){this.clusterClass_=e},MarkerClusterer.prototype.getMarkers=function(){return this.markers_},MarkerClusterer.prototype.getTotalMarkers=function(){return this.markers_.length},MarkerClusterer.prototype.getClusters=function(){return this.clusters_},MarkerClusterer.prototype.getTotalClusters=function(){return this.clusters_.length},MarkerClusterer.prototype.addMarker=function(e,t){this.pushMarkerTo_(e),t||this.redraw_()},MarkerClusterer.prototype.addMarkers=function(e,t){var o;for(o in e)e.hasOwnProperty(o)&&this.pushMarkerTo_(e[o]);t||this.redraw_()},MarkerClusterer.prototype.pushMarkerTo_=function(e){if(e.getDraggable()){var t=this;google.maps.event.addListener(e,"dragend",function(){t.ready_&&(this.isAdded=!1,t.repaint())})}e.isAdded=!1,this.markers_.push(e)},MarkerClusterer.prototype.removeMarker=function(e,t){var o=this.removeMarker_(e);return!t&&o&&this.repaint(),o},MarkerClusterer.prototype.removeMarkers=function(e,t){var o,i,s=!1;for(o=0;o<e.length;o++)i=this.removeMarker_(e[o]),s=s||i;return!t&&s&&this.repaint(),s},MarkerClusterer.prototype.removeMarker_=function(e){var t,o=-1;if(this.markers_.indexOf)o=this.markers_.indexOf(e);else for(t=0;t<this.markers_.length;t++)if(e===this.markers_[t]){o=t;break}return-1===o?!1:(e.setMap(null),this.markers_.splice(o,1),!0)},MarkerClusterer.prototype.clearMarkers=function(){this.resetViewport_(!0),this.markers_=[]},MarkerClusterer.prototype.repaint=function(){var e=this.clusters_.slice();this.clusters_=[],this.resetViewport_(!1),this.redraw_(),setTimeout(function(){var t;for(t=0;t<e.length;t++)e[t].remove()},0)},MarkerClusterer.prototype.getExtendedBounds=function(e){var t=this.getProjection(),o=new google.maps.LatLng(e.getNorthEast().lat(),e.getNorthEast().lng()),i=new google.maps.LatLng(e.getSouthWest().lat(),e.getSouthWest().lng()),s=t.fromLatLngToDivPixel(o);s.x+=this.gridSize_,s.y-=this.gridSize_;var n=t.fromLatLngToDivPixel(i);n.x-=this.gridSize_,n.y+=this.gridSize_;var a=t.fromDivPixelToLatLng(s),r=t.fromDivPixelToLatLng(n);return e.extend(a),e.extend(r),e},MarkerClusterer.prototype.redraw_=function(){this.createClusters_(0)},MarkerClusterer.prototype.resetViewport_=function(e){var t,o;for(t=0;t<this.clusters_.length;t++)this.clusters_[t].remove();for(this.clusters_=[],t=0;t<this.markers_.length;t++)o=this.markers_[t],o.isAdded=!1,e&&o.setMap(null)},MarkerClusterer.prototype.distanceBetweenPoints_=function(e,t){var o=6371,i=(t.lat()-e.lat())*Math.PI/180,s=(t.lng()-e.lng())*Math.PI/180,n=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(t.lat()*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2),a=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),r=o*a;return r},MarkerClusterer.prototype.isMarkerInBounds_=function(e,t){return t.contains(e.getPosition())},MarkerClusterer.prototype.addToClosestCluster_=function(e){var t,o,i,s,n=4e4,a=null;for(t=0;t<this.clusters_.length;t++)i=this.clusters_[t],s=i.getCenter(),s&&(o=this.distanceBetweenPoints_(s,e.getPosition()),n>o&&(n=o,a=i));a&&a.isMarkerInClusterBounds(e)?a.addMarker(e):(i=new Cluster(this),i.addMarker(e),this.clusters_.push(i))},MarkerClusterer.prototype.createClusters_=function(e){var t,o,i,s=this;if(this.ready_){0===e&&(google.maps.event.trigger(this,"clusteringbegin",this),"undefined"!=typeof this.timerRefStatic&&(clearTimeout(this.timerRefStatic),delete this.timerRefStatic)),i=this.getMap().getZoom()>3?new google.maps.LatLngBounds(this.getMap().getBounds().getSouthWest(),this.getMap().getBounds().getNorthEast()):new google.maps.LatLngBounds(new google.maps.LatLng(85.02070771743472,-178.48388434375),new google.maps.LatLng(-85.08136444384544,178.00048865625));var n=this.getExtendedBounds(i),a=Math.min(e+this.batchSize_,this.markers_.length);for(t=e;a>t;t++)o=this.markers_[t],!o.isAdded&&this.isMarkerInBounds_(o,n)&&(!this.ignoreHidden_||this.ignoreHidden_&&o.getVisible())&&this.addToClosestCluster_(o);a<this.markers_.length?this.timerRefStatic=setTimeout(function(){s.createClusters_(a)},0):(delete this.timerRefStatic,google.maps.event.trigger(this,"clusteringend",this))}},MarkerClusterer.prototype.extend=function(e,t){return function(e){var t;for(t in e.prototype)this.prototype[t]=e.prototype[t];return this}.apply(e,[t])},MarkerClusterer.CALCULATOR=function(e,t){for(var o=0,i="",s=e.length.toString(),n=s;0!==n;)n=parseInt(n/10,10),o++;return o=Math.min(o,t),{text:s,index:o,title:i}},MarkerClusterer.BATCH_SIZE=2e3,MarkerClusterer.BATCH_SIZE_IE=500,MarkerClusterer.IMAGE_PATH="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/images/m",MarkerClusterer.IMAGE_EXTENSION="png",MarkerClusterer.IMAGE_SIZES=[53,56,66,78,90];
